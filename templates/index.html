<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>å£°ã‚’æ¶ˆã•ã›ãªã„ãƒ»è­°è«–æ•´ç†ï¼ˆMVPï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --border:#e5e5e5;
      --muted:#666;
      --bg:#fafafa;
      --card:#fff;
    }
    html,body{margin:0;padding:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Helvetica Neue","ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN","Hiragino Kaku Gothic ProN","æ¸¸ã‚´ã‚·ãƒƒã‚¯",YuGothic,"ãƒ¡ã‚¤ãƒªã‚ª",Meiryo,sans-serif;line-height:1.6}
    a{color:#0b68d7;text-decoration:none}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
    header .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:16px;margin:0}
    main{max-width:900px;margin:18px auto;padding:0 12px}
    .sec{margin-top:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .meta{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .badge.on{background:#eef7ff;border-color:#cbe3ff}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    textarea, input[type="text"], input[type="search"], input[type="email"]{
      width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit
    }
    textarea{min-height:140px;resize:vertical}
    button{appearance:none;border:1px solid var(--border);background:#111;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .post{border:1px solid #eee;border-radius:10px;padding:12px;background:#fff}
    .post .meta{margin-bottom:6px}
    .truncate-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    details > summary{cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .right{display:flex;justify-content:flex-end}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    ul.clean{list-style:none;padding-left:0;margin:0}
    ul.clean li{padding:6px 0;border-top:1px dashed #eee}
    ul.clean li:first-child{border-top:none}
    .copy-input{width:280px}

    /* å…ˆé ­æ–‡ã‚’ã‚µãƒãƒªã«å‡ºã—ã€å±•é–‹æ™‚ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éš ã™ */
    details.message[open] summary .preview{ display:none }
    details.message summary .toggle{ margin-left:.25rem }
  </style>

</head>
<body>
  <header>
    <div class="row">
      <h1>å£°ã‚’æ¶ˆã•ã›ãªã„ãƒ»è­°è«–æ•´ç†ï¼ˆMVPï¼‰</h1>
      <span class="muted">/ <a href="/threads">è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ²ç¤ºæ¿</a></span>
    </div>
  </header>

  <main>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ¬ãƒƒãƒ‰ã¨å…¬é–‹ãƒˆã‚°ãƒ« -->
    <section class="sec">
      <div class="row">
        <div class="pill">
          <strong>ç¾åœ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰</strong>:
          <span>#{{ active_thread_id if active_thread_id else '-' }}</span>
        </div>

        {% set is_public = True if share_url else False %}
        <div class="pill">
          <span class="badge {{ 'on' if is_public else '' }}">{{ 'å…¬é–‹ä¸­' if is_public else 'éå…¬é–‹' }}</span>
          {% if active_thread_id and g.current_user %}
          <form method="post" action="/threads/{{ active_thread_id }}/publish" class="row" style="gap:6px;margin-left:6px">
            <input type="hidden" name="make_public" value="{{ 'true' if is_public else 'false' }}">
            <button class="secondary" type="submit">{{ 'éå…¬é–‹ã«ã™ã‚‹' if is_public else 'å…¬é–‹ã™ã‚‹' }}</button>
          </form>
          {% endif %}
        </div>

        {% if share_url %}
        <div class="row">
          <span class="muted">å…±æœ‰URL:</span>
          <input class="copy-input" value="{{ share_url }}" readonly onclick="this.select()">
          <button class="secondary" type="button" id="copyBtn">ã‚³ãƒ”ãƒ¼</button>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- AIã®æ•´ç†ï¼ˆè¦ç‚¹â†’å…¨æ–‡ï¼‰ -->
    <section class="sec card" id="ai-card" {% if not result %}style="display:none"{% endif %}>
      <h3 style="margin:0 0 8px">AIã®æ•´ç†ï¼ˆè¦ç‚¹3ã¤ï¼‰</h3>
      <div id="ai-points"></div>
      <details style="margin-top:8px">
        <summary>å…¨æ–‡ã‚’è¡¨ç¤º</summary>
        <div id="ai-full" style="white-space:pre-wrap;margin-top:8px">{{ result or '' }}</div>
      </details>
    </section>

<!-- è¨˜äº‹æœ¬æ–‡ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
<section class="sec card">
  <details {% if not article %}open{% endif %}>
    <summary><strong>è¨˜äº‹æœ¬æ–‡ / è¦ç´„</strong>ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
    <div style="margin-top:8px">
      {% if g.current_user %}
      <!-- âœ… ãƒ•ã‚©ãƒ¼ãƒ â‘ ï¼šAIã«ç­”ãˆã¦ã‚‚ã‚‰ã†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <form method="post" action="/analyze">
        <label for="article" class="sr-only">è¨˜äº‹æœ¬æ–‡ / è¦ç´„</label>
        <textarea id="article" name="article" placeholder="ã“ã“ã«è¨˜äº‹æœ¬æ–‡ã‹è¦ç´„ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚">{{ article or '' }}</textarea>

        <div class="divider"></div>

        <label for="comment" class="sr-only">ã‚ãªãŸã®ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea id="comment" name="comment" placeholder="ä¾‹ï¼‰ç¦æ­¢ã‚ˆã‚Šã€ä»£æ›¿æ¡ˆã‚’ã‚»ãƒƒãƒˆã§å‡ºã™ã¹ãã§ã¯ï¼Ÿ"></textarea>

        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <input type="text" name="thread_title" placeholder="æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰åï¼ˆä»»æ„ï¼‰">
          </div>
          <div>
            <select name="thread_id">
              <option value="">æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ã§æŠ•ç¨¿</option>
              {% for t in threads %}
                <option value="{{ t.id }}" {% if active_thread_id and t.id==active_thread_id %}selected{% endif %}>#{{ t.id }} {{ t.title or 'ç„¡é¡Œ' }}</option>
              {% endfor %}
            </select>
          </div>
        </div>


        <div class="right" style="margin-top:8px">
          <button type="submit">AIã«ç­”ãˆã¦ã‚‚ã‚‰ã†ï¼ˆâŒ˜/Ctrl+Enterï¼‰</button>
        </div>
      </form>
      {% else %}
        <div class="muted" style="margin-top:6px">
          {% if not g.current_user %}
            æŠ•ç¨¿ã™ã‚‹ã«ã¯ <a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a> ã—ã¦ãã ã•ã„ã€‚
          {% else %}
            è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆã ã‘æŠ•ç¨¿ã™ã‚‹ã«ã¯ã€å³ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸ã¶ã‹ã€ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã§æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚
          {% endif %}
        </div>
      {% endif %}
      <div class="divider"></div>

      <!-- ã“ã“ã‹ã‚‰ï¼šæœ¬äººã®ã‚³ãƒ¡ãƒ³ãƒˆã ã‘æŠ•ç¨¿ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ  -->
      {% if active_thread_id and g.current_user %}
        <div class="divider"></div>
        <form method="post" action="/threads/{{ active_thread_id }}/posts">
          <label for="only-comment" class="sr-only">ã‚ãªãŸã®ã‚³ãƒ¡ãƒ³ãƒˆã ã‘æŠ•ç¨¿</label>
          <textarea id="only-comment" name="content" placeholder="ã‚ãªãŸã®ã‚³ãƒ¡ãƒ³ãƒˆã ã‘æŠ•ç¨¿" required></textarea>
          <div class="right" style="margin-top:8px">
            <button type="submit" class="secondary">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹</button>
          </div>
        </form>
      {% endif %}
      <!-- ã“ã“ã¾ã§ -->

    </div>
  </details>
</section>

    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <section class="sec">
      <h3 style="margin:0 0 8px">ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å±¥æ­´</h3>
      {% if history and history|length > 0 %}
        {% for m in history|reverse %} {# æ–°ã—ã„é †ã«è¡¨ç¤º #}
          <div class="post">
            <div class="meta">{{ 'ğŸ‘¤' if m.role=='user' else ('ğŸ¤–' if m.role=='assistant' else 'ğŸ›ˆ') }} {{ m.created_at }}</div>
            <details class="message">
              <summary>
                <span class="preview"></span>
                <span class="toggle muted">ï¼ˆå…¨æ–‡ã‚’è¡¨ç¤ºï¼‰</span>
              </summary>
              <div class="full" style="white-space:pre-wrap;margin-top:6px">{{ m.content }}</div>
            </details>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      {% endif %}
    </section>

    <!-- ã‚µã‚¤ãƒ‰/ä¸‹éƒ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ -->
    <section class="sec card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ã‚¹ãƒ¬ãƒƒãƒ‰</h3>
        <a href="/threads">æ²ç¤ºæ¿ã¸</a>
      </div>
      <ul class="clean">
        {% for t in threads %}
          <li>
            <a href="/?thread_id={{ t.id }}">#{{ t.id }} {{ t.title or 'ç„¡é¡Œ' }}</a>
            <span class="meta"> / {{ t.created_at }}</span>
          </li>
        {% endfor %}
      </ul>
    </section>
  </main>

  <script>
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const inp = document.querySelector('.copy-input');
        if (!inp) return;
        inp.select();
        try { await navigator.clipboard.writeText(inp.value); copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'; setTimeout(()=>copyBtn.textContent='ã‚³ãƒ”ãƒ¼',1200); } catch(e){}
      });
    }

    // /analyze ãƒ•ã‚©ãƒ¼ãƒ : Cmd/Ctrl+Enter ã§é€ä¿¡
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        const ta = document.activeElement && document.activeElement.tagName === 'TEXTAREA';
        const form = ta ? document.activeElement.closest('form') : null;
        if (form) form.submit();
      }
    });

    // AIã®æ•´ç†ï¼šè¦ç‚¹3ã¤ã‚’è‡ªå‹•æŠ½å‡ºï¼ˆç°¡æ˜“åˆ†å‰²ï¼‰
    (function(){
      const full = document.getElementById('ai-full');
      const points = document.getElementById('ai-points');
      const card = document.getElementById('ai-card');
      if (!full || !points || !card) return;
      const text = (full.textContent || '').trim();
      if (!text) { card.style.display='none'; return; }

      // å¥ç‚¹ãƒ»ç–‘å•ç¬¦ãƒ»æ„Ÿå˜†ç¬¦ã§ã–ã£ãã‚Šåˆ†å‰²ï¼ˆæ—¥æœ¬èªç°¡æ˜“ï¼‰
      const sents = text
        .replace(/\s+/g,' ')
        .split(/(?<=[ã€‚ï¼ï¼Ÿ\?ï¼])/);

      const top = sents.filter(s => s.trim()).slice(0,3);
      if (top.length === 0) { points.innerHTML = '<div class="muted">è¦ç‚¹ãªã—</div>'; return; }

      const ul = document.createElement('ul');
      ul.className = 'clean';
      top.forEach(s => {
        const li = document.createElement('li'); li.textContent = s.trim();
        ul.appendChild(li);
      });
      points.appendChild(ul);
    })();


     // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šã‚µãƒãƒªã«å…ˆé ­1æ–‡ã€å±•é–‹æ™‚ã¯å…¨æ–‡ã‚’1ã‹æ‰€ã ã‘è¡¨ç¤º
    (function(){
      const splitJA = (txt) => {
        // å¥ç‚¹ãƒ»ç–‘å•ãƒ»æ„Ÿå˜†ã®ç›´å¾Œã§åˆ†å‰²ï¼ˆæ—¥æœ¬èªå¯„ã›ãƒ»ç°¡æ˜“ï¼‰
        const parts = (txt || '').trim().replace(/\s+/g,' ')
          .split(/(?<=[ã€‚ï¼ï¼Ÿ\?ï¼])/);
        const first = parts.shift() || '';
        return { first, rest: parts.join('') };
      };
      document.querySelectorAll('details.message').forEach(d => {
        const full = d.querySelector('.full');
        const prev = d.querySelector('.preview');
        const toggle = d.querySelector('.toggle');
        if (!full || !prev) return;
        const raw = (full.textContent || '').trim();
        if (!raw) { prev.textContent = '(å†…å®¹ãªã—)'; return; }
        const { first } = splitJA(raw);
        // ã‚µãƒãƒªã¯å…ˆé ­1æ–‡ï¼ˆé•·ã‘ã‚Œã°çœç•¥ï¼‰
        const summary = (first || raw).trim();
        prev.textContent = summary.length > 180 ? summary.slice(0,180) + 'â€¦' : summary;
        // æœ¬æ–‡ã¯å¸¸ã«ã€Œå…¨æ–‡ã€ã‚’è¡¨ç¤ºï¼ˆé–‹ã„ãŸã‚‰ã‚µãƒãƒªã¯éè¡¨ç¤ºã«ã™ã‚‹ã®ã§é‡è¤‡ã—ãªã„ï¼‰
        full.textContent = raw;
        d.addEventListener('toggle', () => {
          if (toggle) toggle.textContent = d.open ? 'ï¼ˆé–‰ã˜ã‚‹ï¼‰' : 'ï¼ˆå…¨æ–‡ã‚’è¡¨ç¤ºï¼‰';
        });
      });
    })();

  </script>
</body>
</html>